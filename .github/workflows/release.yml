name: Build and Release Docset

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (leave empty for auto YYYY.MM.DD)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Nix cache
        uses: cachix/cachix-action@v13
        with:
          name: nushell-docset
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(date +%Y.%m.%d)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build docset release
        run: |
          nix develop --command python build_release.py \
            --output releases \
            --version "${{ steps.version.outputs.VERSION }}" \
            --github-release \
            --repo "${{ github.repository }}"

      - name: Create release notes
        id: notes
        run: |
          cat > release-notes.md << 'EOF'
          # Nushell Docset v${{ steps.version.outputs.VERSION }}

          ## Installation

          ### Dash (macOS)
          1. Download `Nushell.tgz` below
          2. Double-click to install, or
          3. Copy to `~/Library/Application Support/Dash/DocSets/`

          ### Zeal (Linux/Windows)
          Subscribe to the feed URL:
          ```
          https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/Nushell.xml
          ```

          Or download `Nushell.tgz` manually:
          1. Open Zeal
          2. Tools → Docsets → Add Feed → Browse
          3. Select the extracted `Nushell.docset` directory

          ## What's Included
          - Complete Nushell documentation
          - Command reference
          - Language guide
          - Cookbook examples
          - Searchable index with 770+ entries

          ## Checksums
          See `Nushell-${{ steps.version.outputs.VERSION }}.json` for complete checksums.

          ---
          Generated from [nushell.github.io](https://github.com/nushell/nushell.github.io)
          EOF
          cat release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Nushell Docset v${{ steps.version.outputs.VERSION }}
          body_path: release-notes.md
          files: |
            releases/Nushell-${{ steps.version.outputs.VERSION }}.tgz
            releases/Nushell.tgz
            releases/Nushell.xml
            releases/Nushell-${{ steps.version.outputs.VERSION }}.json
          draft: false
          prerelease: false

      - name: Update latest feed
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          mkdir -p feeds
          cp releases/Nushell.xml feeds/Nushell.xml

          git add feeds/Nushell.xml
          git commit -m "Update feed for v${{ steps.version.outputs.VERSION }}" || true
          git push origin HEAD:main || true
